# ThreeBodyChat

**ThreeBodyChat** ã¯ã€ã€Œäººé–“ + 2ä½“ã®LLMï¼ˆå¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«ï¼‰ã€ãŒä¸‰ä½ä¸€ä½“ã¨ãªã£ã¦ä¼šè©±ã‚’è¡Œã†ã€æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆä½“é¨“ã‚’ç›®æŒ‡ã™ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚  
åå‰ã®ç”±æ¥ã¯ä¸­å›½SFå°èª¬ã€ä¸‰ä½“ã€ã‹ã‚‰ç€æƒ³ã‚’å¾—ã¦ãŠã‚Šã€3è€…ã®å¯¾è©±ã«ã‚ˆã£ã¦ã‚«ã‚ªã‚¹ã§ã¯ãªããƒãƒ©ãƒ³ã‚¹ã‚’ç”Ÿã¿å‡ºã™è¨­è¨ˆæ€æƒ³ã«åŸºã¥ã„ã¦ã„ã¾ã™ã€‚

## ğŸŒŸ ã‚³ãƒ³ã‚»ãƒ—ãƒˆ

- LLMã‚’ã€Œãƒ¡ã‚¤ãƒ‰ã€ã€Œå¸«åŒ ã€ãªã©ã®äººæ ¼ã¨ã—ã¦ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åŒ–
- Discordä¸Šã§è¤‡æ•°AIã¨åŒæ™‚ã«ä¼šè©±ãŒã§ãã‚‹ã€Œãƒãƒ«ãƒãƒœãƒƒãƒˆæ§‹æˆã€
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®ã‚„ã‚Šå–ã‚Šã®ä¸­ã§ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŸã¡ã®â€œäººæ ¼â€ãŒé€²åŒ–ã™ã‚‹ä»•çµ„ã¿ï¼ˆäºˆå®šï¼‰
- å¿œç­”åˆ¶å¾¡ãƒ»ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã£ã¦è‡ªç„¶ãªä¼šè©±ã‚’å®Ÿç¾
- UIã®åˆ¶ç´„ã‚’æ’ã—ã€ã€Œè¨˜æ†¶ï¼ˆMemoryï¼‰ã€ã‚’ä¸­æ ¸ã«æ®ãˆãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè¨­è¨ˆ

---

## ğŸ“‚ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆ

```bash
ThreeBodyChat/
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ compose.yml
â”œâ”€â”€ poetry.toml
â”œâ”€â”€ pyproject.toml
â”œâ”€â”€ poetry.lock
â”œâ”€â”€ README.md
â”œâ”€â”€ tests/
â””â”€â”€ threebodychat/
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ Maid.py      # ãƒ¡ã‚¤ãƒ‰Botã®å®Ÿè£…
    â”œâ”€â”€ Master.py    # å¸«åŒ Botã®å®Ÿè£…äºˆå®š
    â””â”€â”€ config.py    # Discordãƒˆãƒ¼ã‚¯ãƒ³ãªã©ã®è¨­å®š
```
ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€
## Redisã«ã¤ã„ã¦

**Redis**ã¯ã€ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªå‹ã®é«˜é€Ÿãªãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ï¼ˆNoSQLãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼‰ã§ã™ã€‚
æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€Boté–“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ¥ãƒ¼ã¨ã—ã¦Redisã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚
OrchestratorãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºè¨€ã‚’Redisã‚­ãƒ¥ãƒ¼ã«æ›¸ãè¾¼ã¿ã€Maid/Master BotãŒãã®ã‚­ãƒ¥ãƒ¼ã‚’ç›£è¦–ã—ã¦è¿”ç­”ã™ã‚‹è¨­è¨ˆã§ã™ã€‚

### Redisã®å°å…¥ãƒ»èµ·å‹•æ–¹æ³•ï¼ˆUbuntu/WSLã®å ´åˆï¼‰

1. Redisã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
   ```sh
   sudo apt update
   sudo apt install redis-server
   ```

2. Redisã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•
   ```sh
   sudo service redis-server start
   ```

3. å‹•ä½œç¢ºèª
   ```sh
   redis-cli ping
   ```
   `PONG` ã¨è¿”ã£ã¦ãã‚Œã°OKã§ã™ã€‚

> Dockerã§Redisã‚’ä½¿ã„ãŸã„å ´åˆã¯
> `docker run -d -p 6379:6379 --name redis redis`
> ã§ã‚‚èµ·å‹•ã§ãã¾ã™ã€‚

## ğŸ§ª ãƒ†ã‚¹ãƒˆã«ã¤ã„ã¦

æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€å„Botã‚„Orchestratorã®ä¸»è¦ãªå‡¦ç†ã«ã¤ã„ã¦pytestã«ã‚ˆã‚‹ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’ç”¨æ„ã—ã¦ã„ã¾ã™ã€‚

- Orchestratorã®å‰²ã‚ŠæŒ¯ã‚Šãƒ­ã‚¸ãƒƒã‚¯ã‚„Redisã‚­ãƒ¥ãƒ¼æ›¸ãè¾¼ã¿ã®ãƒ†ã‚¹ãƒˆ
- Maid/Masterã®Redisã‚­ãƒ¥ãƒ¼å–å¾—ãƒ»è¿”ç­”ãƒ­ã‚¸ãƒƒã‚¯ã®ãƒ†ã‚¹ãƒˆ
- ãƒ©ãƒ³ãƒ€ãƒ è¿”ç­”ãŒè¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³å‡ºã‚‹ã‹ã®ãƒ†ã‚¹ãƒˆ

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ–¹æ³•

1. ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆåˆå›ã®ã¿ï¼‰
   ```sh
   poetry install
   ```
2. Redisã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
   ```sh
   sudo service redis-server start
   # ã¾ãŸã¯ docker run -d -p 6379:6379 --name redis redis
   ```
3. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã§pytestã‚’å®Ÿè¡Œ
   ```sh
   poetry run pytest
   ```

### ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä¾‹
- `tests/test_orchestrator.py`ï¼šOrchestratorã®å‰²ã‚ŠæŒ¯ã‚Šãƒ»ã‚­ãƒ¥ãƒ¼æ›¸ãè¾¼ã¿ãƒ†ã‚¹ãƒˆ
- `tests/test_Maid.py`ï¼šMaidã®Redisã‚­ãƒ¥ãƒ¼å–å¾—ãƒ»è¿”ç­”ãƒ­ã‚¸ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ
- `tests/test_Master.py`ï¼šMasterã®Redisã‚­ãƒ¥ãƒ¼å–å¾—ãƒ»è¿”ç­”ãƒ­ã‚¸ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ

å„ãƒ†ã‚¹ãƒˆã«ã¯åˆå¿ƒè€…å‘ã‘ã®è©³ç´°ãªã‚³ãƒ¡ãƒ³ãƒˆã‚‚è¨˜è¼‰ã—ã¦ã„ã¾ã™ã€‚

## ğŸ›  Redisã«ã‚ˆã‚‹ãƒãƒ«ãƒBotåˆ¶å¾¡ã®ä»•çµ„ã¿

ThreeBodyChatã§ã¯ã€Boté–“ã®ã‚„ã‚Šã¨ã‚Šã‚„å½¹å‰²åˆ†æ‹…ã‚’**Redisã®ã‚­ãƒ¥ãƒ¼æ©Ÿèƒ½**ã§åˆ¶å¾¡ã—ã¦ã„ã¾ã™ã€‚

### åˆ¶å¾¡ãƒ•ãƒ­ãƒ¼ã®æ¦‚è¦

1. **Orchestratorï¼ˆå¸ä»¤å¡”Botï¼‰**
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®Discordç™ºè¨€ã‚’å—ä¿¡
   - ã©ã¡ã‚‰ã®Botï¼ˆMaid/Masterï¼‰ãŒè¿”ç­”ã™ã‚‹ã‹ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã§æ±ºå®š
   - Redisã®è©²å½“ã‚­ãƒ¥ãƒ¼ï¼ˆmaid_queue/master_queueï¼‰ã« `rpush` ã§ã€Œchannel_id|user_id|message_contentã€ã‚’è¿½åŠ 
2. **Maid / Master Bot**
   - ãã‚Œãã‚Œè‡ªåˆ†ç”¨ã®Redisã‚­ãƒ¥ãƒ¼ï¼ˆmaid_queue/master_queueï¼‰ã‚’ `lpop` ã§å®šæœŸç›£è¦–
   - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Œã°ã€å†…å®¹ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦Discordãƒãƒ£ãƒ³ãƒãƒ«ã«è¿”ç­”

### ãƒã‚¤ãƒ³ãƒˆ
- å„Botã¯**ç‹¬ç«‹ãƒ—ãƒ­ã‚»ã‚¹ãƒ»ç‹¬ç«‹ãƒˆãƒ¼ã‚¯ãƒ³**ã§å‹•ä½œã—ã€ç›´æ¥é€šä¿¡ã¯ã—ã¾ã›ã‚“
- Orchestratorâ†’Redisâ†’Botã®**ä¸€æ–¹å‘åˆ¶å¾¡**ã§ç–çµåˆãƒ»ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ãªè¨­è¨ˆ
- Redisã‚’ä½¿ã†ã“ã¨ã§ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‹ã¤è»½é‡ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ‘ã‚¹ã‚’å®Ÿç¾

### å›³å¼ã‚¤ãƒ¡ãƒ¼ã‚¸

```
[ãƒ¦ãƒ¼ã‚¶ãƒ¼] â†’ [Orchestrator] â†’ (maid_queue/master_queue in Redis) â†’ [Maid/Master] â†’ [Discordãƒãƒ£ãƒ³ãƒãƒ«]
```

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºè¨€ã®å—ã‘æ¸¡ã—è¨­è¨ˆ

- Maid/Masterã®ã©ã¡ã‚‰ãŒå…ˆãƒ»å¾Œæ‰‹ã«ãªã£ã¦ã‚‚ã€**å¿…ãšãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç™ºè¨€å†…å®¹ã¯ä¸¡æ–¹ã®Botã«æ¸¡ã•ã‚Œã¾ã™**ã€‚
- å…ˆæ‰‹Botã«ã¯ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºè¨€ã€ã®ã¿ãŒæ¸¡ã•ã‚Œã€å¾Œæ‰‹Botã«ã¯ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºè¨€ï¼‹å…ˆæ‰‹Botã®è¿”ç­”ã€ãŒæ¸¡ã•ã‚Œã¾ã™ã€‚
- ã“ã‚Œã«ã‚ˆã‚Šã€**ã©ã¡ã‚‰ã®Botã‚‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç™ºè¨€å†…å®¹ã‚’å¿…ãšå–å¾—ã§ãã€ä»Šå¾Œã®é–¢æ•°è¨­è¨ˆã§å¼•æ•°ã¨ã—ã¦è‡ªç”±ã«åˆ©ç”¨ã§ãã¾ã™**ã€‚

#### ä¾‹
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œã“ã‚“ã«ã¡ã¯ã€
2. OrchestratorãŒMaidã‚’å…ˆæ‰‹ã«é¸ã¶
3. Maidã«ã¯ã€Œã“ã‚“ã«ã¡ã¯ã€ãŒæ¸¡ã•ã‚Œã‚‹
4. MaidãŒè¿”ç­”ã—ãŸå¾Œã€Masterã«ã¯ã€Œã“ã‚“ã«ã¡ã¯ï½œMaidã®è¿”ç­”ã€ãŒæ¸¡ã•ã‚Œã‚‹

> ã©ã¡ã‚‰ãŒå…ˆæ‰‹ãƒ»å¾Œæ‰‹ã§ã‚‚ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºè¨€ã¯å¿…ãšä¸¡Botã«ä¼ã‚ã‚‹**ãŸã‚ã€  
> Botã®å¿œç­”ãƒ­ã‚¸ãƒƒã‚¯ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºè¨€ã‚’å¼•æ•°ã¨ã—ã¦åˆ©ç”¨ã§ãã¾ã™ã€‚

## å‚è€ƒæ–‡çŒ®
- [Discord Botã®ã¤ãã‚Šã‹ãŸ](https://qiita.com/shown_it/items/6e7fb7777f45008e0496)
- [discord.pyå…¥é–€](https://qiita.com/float_py/items/f2fd2f56f9536520b36a)